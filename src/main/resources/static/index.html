<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8" />
        <title>SimulationView</title>
    </head>

    <body style="margin: 0px; padding: 0px; overflow: hidden">
        <canvas id="c" style="width: 100%; height: 100%;"></canvas>

        <script type="module">
            import * as THREE from 'https://threejsfundamentals.org/threejs/resources/threejs/r122/build/three.module.js';
            import {OrbitControls} from 'https://threejsfundamentals.org/threejs/resources/threejs/r122/examples/jsm/controls/OrbitControls.js';
            import {OBJLoader} from 'https://threejsfundamentals.org/threejs/resources/threejs/r122/examples/jsm/loaders/OBJLoader.js';
            import {MTLLoader} from 'https://threejsfundamentals.org/threejs/resources/threejs/r122/examples/jsm/loaders/MTLLoader.js';

            function parseCommand(input = "") {
                return JSON.parse(input);
            }

            var socket;
            var camera;
            var controls;
            var renderer;
            var scene;

            const fov = 45;
            const aspect = 2; 
            const near = 0.1;
            const far = 100;

            var worldObjects = {};

            window.onload = function(){

                function init(){
                    var worldObjects = {};
                    const canvas = document.querySelector('#c');
                    
                    renderer = new THREE.WebGLRenderer({canvas});
                    renderer.setPixelRatio(window.devicePixelRatio);
                    renderer.setSize(window.innerWidth, window.innerHeight + 5);

                    camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 1, 1000);
                    camera.position.set(0, 10, 20);

                    controls = new OrbitControls(camera, canvas);
                    controls.target.set(0, 5, 0);
                    controls.update();

                    scene = new THREE.Scene();
                    scene.background = new THREE.Color('black');

                    const planeSize = 40;
                    const skyColor = 0xB1E1FF;
                    const groundColor = 0xB97A20; 
                    const intensity = 1;
                    const light = new THREE.HemisphereLight(skyColor, groundColor, intensity);
                    scene.add(light);
                }

                function onWindowResize() {
                    camera.aspect = window.innerWidth / window.innerHeight;
                    camera.updateProjectionMatrix();
                    renderer.setSize(window.innerWidth, window.innerHeight);
                }

                function animate() {
                    requestAnimationFrame(animate);
                    controls.update();
                    renderer.render(scene, camera);
                }    

                
                socket = new WebSocket("ws://" + window.location.hostname + ":" + window.location.port + "/connectToSimulation");
                
                socket.onmessage = function(event){
                    var command = JSON.parse(event.data);

                    if (command.command == "object_update") {
                        if (Object.keys(worldObjects).indexOf(command.parameters.uuid) < 0) {
                            if (command.parameters.type == "robot") {
                                var geometry = new THREE.BoxGeometry(0.9, 0.3, 0.9);
                                var cubeMaterials = [
                                    new THREE.MeshBasicMaterial({ map: new THREE.TextureLoader().load("textures/robot_side.png"), side: THREE.DoubleSide }),
                                    new THREE.MeshBasicMaterial({ map: new THREE.TextureLoader().load("textures/robot_side.png"), side: THREE.DoubleSide }), 
                                    new THREE.MeshBasicMaterial({ map: new THREE.TextureLoader().load("textures/robot_top.png"), side: THREE.DoubleSide }), 
                                    new THREE.MeshBasicMaterial({ map: new THREE.TextureLoader().load("textures/robot_bottom.png"), side: THREE.DoubleSide }), 
                                    new THREE.MeshBasicMaterial({ map: new THREE.TextureLoader().load("textures/robot_front.png"), side: THREE.DoubleSide }), 
                                    new THREE.MeshBasicMaterial({ map: new THREE.TextureLoader().load("textures/robot_front.png"), side: THREE.DoubleSide })
                                ];

                                var material = new THREE.MeshFaceMaterial(cubeMaterials);
                                var robot = new THREE.Mesh(geometry, material);
                                robot.position.y = 0.15;

                                var group = new THREE.Group();
                                group.add(robot);

                                scene.add(group);
                                worldObjects[command.parameters.uuid] = group;
                            }

                            if (command.parameters.type == "stellage"){

                                var geometry = new THREE.BoxGeometry(1, 1, 5);
                                var material = new THREE.MeshBasicMaterial({color: 0x0000ff, side: THREE.DoubleSide });

                                var stellage = new THREE.Mesh(geometry, material);
                                stellage.rotation.x = Math.PI / 2.0;

                                var group = new THREE.Group();
                                group.add(stellage);
                                group.name = command.parameters.uuid;

                                scene.add(group);
                                worldObjects[command.parameters.uuid] = group;
                            }

                            if (command.parameters.type == "truck"){    
                                var mtlLoader = new MTLLoader();
                                mtlLoader.setPath("models/");
                                mtlLoader.load("car.mtl", function(materials){
                                    materials.preload();
                                    var objLoader = new OBJLoader();
                                    objLoader.setMaterials(materials);
                                    objLoader.setPath("models/");
                                    objLoader.load("car.obj", function(object){
                                        var truck = object;
                                        truck.scale.set(0.8, 0.8, 0.8);
                                        truck.rotation.y = 36.15;
                                        var group = new THREE.Group();
                                        group.add(truck);
                                        group.name = command.parameters.uuid;

                                        scene.add(group);
                                        worldObjects[command.parameters.uuid] = group;
                                    });
                                });
                            }
                        } 

                        var object = worldObjects[command.parameters.uuid];

                        if(object != undefined){
                            object.position.x = command.parameters.x;
                            object.position.y = command.parameters.y;
                            object.position.z = command.parameters.z;

                            object.rotation.x = command.parameters.rotationX;
                            object.rotation.y = command.parameters.rotationY;
                            object.rotation.z = command.parameters.rotationZ;
                        }
                    } else if (command.command == "object_delete"){
                        var object = scene.getObjectByName(command.parameters.uuid);
                        console.log(object);
         
                        scene.remove(object);
                        
                        delete worldObjects[command.parameters.uuid];
                        console.log("deleted truck");
                        animate();
                    }
                };

                init();
                animate();
            }
        </script>
    </body>

</html>