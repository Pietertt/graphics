<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8" />
    <title>SimulationView</title>
</head>

<body style="margin: 0px; padding: 0px; overflow: hidden">
    <canvas id="c" style="width: 100%; height: 100%;"></canvas>

    <!--
            Deze pagina is de standaardpagina van de client. Hierin wordt de 3D wereld opgezet en wordt geluisterd
            naar updates vanaf de server over de websocket communicatie.
        -->
        <script type="module">
            import * as THREE from 'https://threejsfundamentals.org/threejs/resources/threejs/r122/build/three.module.js';
            import {OrbitControls} from 'https://threejsfundamentals.org/threejs/resources/threejs/r122/examples/jsm/controls/OrbitControls.js';
            import {OBJLoader} from 'https://threejsfundamentals.org/threejs/resources/threejs/r122/examples/jsm/loaders/OBJLoader.js';
            import {MTLLoader} from 'https://threejsfundamentals.org/threejs/resources/threejs/r122/examples/jsm/loaders/MTLLoader.js';
    
            function parseCommand(input = "") {
                return JSON.parse(input);
            }
    
            function main() {
                var worldObjects = {};
                const canvas = document.querySelector('#c');
                const renderer = new THREE.WebGLRenderer({canvas});
    
                var socket;
    
                const fov = 45;
                const aspect = 2;  // the canvas default
                const near = 0.1;
                const far = 100;
                const camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 1, 1000);
                camera.position.set(0, 10, 20);
    
                const controls = new OrbitControls(camera, canvas);
                controls.target.set(0, 5, 0);
                controls.update();
    
                const scene = new THREE.Scene();
                scene.background = new THREE.Color('black');
    
                const planeSize = 40;
    
                const loader = new THREE.TextureLoader();
                const texture = loader.load('https://threejsfundamentals.org/threejs/resources/images/checker.png');
                texture.wrapS = THREE.RepeatWrapping;
                texture.wrapT = THREE.RepeatWrapping;
                texture.magFilter = THREE.NearestFilter;
                const repeats = planeSize / 2;
                texture.repeat.set(repeats, repeats);
    
                const planeGeo = new THREE.PlaneBufferGeometry(planeSize, planeSize);
                const planeMat = new THREE.MeshPhongMaterial({
                map: texture,
                side: THREE.DoubleSide,
                });
                const mesh = new THREE.Mesh(planeGeo, planeMat);
                mesh.position.x = 20;
                mesh.position.z = 20;
                mesh.rotation.x = Math.PI * -.5;
                scene.add(mesh);
    
                const skyColor = 0xB1E1FF;  // light blue
                const groundColor = 0xB97A20;  // brownish orange
                const intensity = 1;
                const light = new THREE.HemisphereLight(skyColor, groundColor, intensity);
                scene.add(light);
    
                function resizeRendererToDisplaySize(renderer) {
                    const canvas = renderer.domElement;
                    const width = canvas.clientWidth;
                    const height = canvas.clientHeight;
                    const needResize = canvas.width !== width || canvas.height !== height;
                    if (needResize) {
                        renderer.setSize(width, height, false);
                    }
                    return needResize;
                }
    
                function render() {
    
                    if (resizeRendererToDisplaySize(renderer)) {
                        const canvas = renderer.domElement;
                        camera.aspect = canvas.clientWidth / canvas.clientHeight;
                        camera.updateProjectionMatrix();
                    }
    
                    renderer.render(scene, camera);
    
                    requestAnimationFrame(render);
                }
    
                requestAnimationFrame(render);
    
                socket = new WebSocket(
                    "ws://" +
                    window.location.hostname +
                    ":" +
                    window.location.port +
                    "/connectToSimulation"
                );
                console.log(socket);
                socket.onmessage = function (event) {
                    //Hier wordt het commando dat vanuit de server wordt gegeven uit elkaar gehaald
                    var command = JSON.parse(event.data);
    
                    //Wanneer het commando is "object_update", dan wordt deze code uitgevoerd. Bekijk ook de servercode om dit goed te begrijpen.
                    if (command.command == "object_update") {
                        //Wanneer het object dat moet worden geupdate nog niet bestaat (komt niet voor in de lijst met worldObjects op de client),
                        //dan wordt het 3D model eerst aangemaakt in de 3D wereld.
                        if (Object.keys(worldObjects).indexOf(command.parameters.uuid) < 0) {
                            //Wanneer het object een robot is, wordt de code hieronder uitgevoerd.
                            if (command.parameters.type == "robot") {
                                var geometry = new THREE.BoxGeometry(0.9, 0.3, 0.9);
                                var cubeMaterials = [
                                    new THREE.MeshBasicMaterial({
                                        map: new THREE.TextureLoader().load(
                                            "textures/robot_side.png"
                                        ),
                                        side: THREE.DoubleSide,
                                    }), //LEFT
                                    new THREE.MeshBasicMaterial({
                                        map: new THREE.TextureLoader().load(
                                            "textures/robot_side.png"
                                        ),
                                        side: THREE.DoubleSide,
                                    }), //RIGHT
                                    new THREE.MeshBasicMaterial({
                                        map: new THREE.TextureLoader().load(
                                            "textures/robot_top.png"
                                        ),
                                        side: THREE.DoubleSide,
                                    }), //TOP
                                    new THREE.MeshBasicMaterial({
                                        map: new THREE.TextureLoader().load(
                                            "textures/robot_bottom.png"
                                        ),
                                        side: THREE.DoubleSide,
                                    }), //BOTTOM
                                    new THREE.MeshBasicMaterial({
                                        map: new THREE.TextureLoader().load(
                                            "textures/robot_front.png"
                                        ),
                                        side: THREE.DoubleSide,
                                    }), //FRONT
                                    new THREE.MeshBasicMaterial({
                                        map: new THREE.TextureLoader().load(
                                            "textures/robot_front.png"
                                        ),
                                        side: THREE.DoubleSide,
                                    }), //BACK
                                ];
                                var material = new THREE.MeshFaceMaterial(cubeMaterials);
                                var robot = new THREE.Mesh(geometry, material);
                                robot.position.y = 0.15;
    
                                var group = new THREE.Group();
                                group.add(robot);
    
                                scene.add(group);
                                worldObjects[command.parameters.uuid] = group;
                            }
    
                            if (command.parameters.type == "stellage"){
                            //     console.log("Created stellage");
                            //     var geometry = new THREE.BoxGeometry(1, 1, 5);
                            //     var material = new THREE.MeshBasicMaterial({
                            //         color: 0x0000ff,
                            //         side: THREE.DoubleSide,
                            //     });
                            //     var plane = new THREE.Mesh(geometry, material);
                            //     plane.rotation.x = Math.PI / 2.0;
                            //     plane.position.x = command.parameters.x;
                            //     plane.position.z = command.parameters.z;
                            //     plane.position.y = command.parameters.y;
                            //     scene.add(plane);
    
                                var geometry = new THREE.BoxGeometry(1, 1, 5);
                                var material = new THREE.MeshBasicMaterial({
                                    color: 0x0000ff,
                                    side: THREE.DoubleSide,
                                });
    
                                var stellage = new THREE.Mesh(geometry, material);
                                stellage.rotation.x = Math.PI / 2.0;
                                // stellage.position.x = command.parameters.x;
                                // stellage.position.z = command.parameters.z;
                                // stellage.position.y = command.parameters.y;
    
                                var group = new THREE.Group();
                                group.add(stellage);
                                group.name = command.parameters.uuid;
    
                                scene.add(group);
                                worldObjects[command.parameters.uuid] = group;
                            }
    
                            if (command.parameters.type == "truck") {
                                // var geometry = new THREE.BoxGeometry(3, 3, 5);
                                // var material = new THREE.MeshBasicMaterial({ color: 0x00ff00 });
    
                                // var robot = new THREE.Mesh(geometry, material);
                                // robot.position.y = 0.15;
    
                                // var group = new THREE.Group();
                                // group.add(robot);
                                // group.name = command.parameters.uuid;
    
                                // scene.add(group);
                                // worldObjects[command.parameters.uuid] = group;
    
                                // const objLoader = new OBJLoader2();
                                // objLoader.load('models/test.obj', (root) => {
                                //     var truck = root;
                                //     //truck.scale.set(0.001, 0.001, 0.001);
                                //     var group = new THREE.Group();
                                //     group.add(truck);
                                //     group.name = command.parameters.uuid;
    
                                //     scene.add(group);
                                //     worldObjects[command.parameters.uuid] = group;
                                // });
    
    
                                var mtlLoader = new MTLLoader();
                                mtlLoader.setPath( "models/" );
                                mtlLoader.load( 'car.mtl', function( materials ) {
                                    materials.preload();
                                    var objLoader = new OBJLoader();
                                    objLoader.setMaterials(materials);
                                    objLoader.setPath("models/");
                                    objLoader.load('car.obj', function(object){
                                        var truck = object;
                                        truck.scale.set(0.8, 0.8, 0.8);
                                        truck.rotation.y = 36.15;
                                        var group = new THREE.Group();
                                        group.add(truck);
                                        group.name = command.parameters.uuid;
    
                                        scene.add(group);
                                        worldObjects[command.parameters.uuid] = group;
                                    });
                                });
                            }
                        } 
    
                        /*
                         * Deze code wordt elke update uitgevoerd. Het update alle positiegegevens van het 3D object.
                         */
                        var object = worldObjects[command.parameters.uuid];
    
                        if(object != undefined){
                            object.position.x = command.parameters.x;
                            object.position.y = command.parameters.y;
                            object.position.z = command.parameters.z;
    
                            object.rotation.x = command.parameters.rotationX;
                            object.rotation.y = command.parameters.rotationY;
                            object.rotation.z = command.parameters.rotationZ;
                        }
    
                    } else if (command.command == "object_delete") {
                            var object = scene.getObjectByName(command.parameters.uuid);
                            scene.remove(object);
                            delete worldObjects[command.parameters.uuid];
                            console.log("deleted truck");
                        }
                };
    }
    
    main();
    
        </script>
</body>

</html>